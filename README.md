# niebex-api
Niebex Api Service

## Installation
- After cloning the project, install dependencies using `npm i`
- Get env details following teh template in the `env.example` file and save them in `.env`
- run the server using the command `npm start`

## Swagger
- Once the server is running, Swagger documentation can be accessed at `http://localhost:<YOUR PORT NUMBER>/docs`
- To add a new entry for an api, go the api's route and write the documentation using openapi spec

## Postman
- as part of the postman, collection in the root folder, there is a env file, import this file into postman to test the api's.
- make sure you have added all the env variables outlined in the .env.example file
- update the postman env variables with tokens generated by running either of the following commands:
    - want to test host functionality?
        - `yarn token:host`
    - want to test customer functionality?
        - `yarn token:customer`
  - a token should be printed out to your terminal, copy it and paste it in the postman env variables section

- There is a POSTMAN json file in the root folder, import this file into postman to test the api's


### Commands
- `yarn start` - start the server
- `yarn studio` - start up prisma studio
- `yarn webhook-test` - test the webhook enpoints 
- `yarn schema-format` - format the prisma schema after making changes
- `yarn migrate` - run local migrations of changes made to the prisma schema
- `yarn migrate-reset` - this will reset the database and delete all previous migrations [don't use unless you know what you are doing]
- `yarn test` - run tests
- `yarn token:host` - generate a token for the host user
- `yarn token:customer` - generate a test token for the customer user
- `yarn bot:jwt` - generate a token for a bot, e.g cronjob bot
- `yarn clear-db` - clear the database, this command will only run on testing environment
- `yarn test-push-notification` - send a push notification to the test device **Note** - this command will only run on testing environment, and you need to have set the `TEST_PUSH_TOKEN` env variable and updated the `DEV_MOBILE_APP_SCHEME` with the url provided by expo, when you run the app on your device


- for deploying the migrations on the production db use `npx prisma migrate deploy `

### Testing
- before running tests, change the ``APP_ENV`` in the `.env` file from `development` to `testing` otherwise the tests will fail
- also add `TEST_HOST_UID` and `TEST_CUSTOMER_UID` to the `.env` file, these are the firebase uids of the test host and customer
- run the tests using the command `yarn test`


### MTN custom scripts
- To make it easier to generate test api users, api keys and tokens use the following commands
- To generate a test user, run the command `yarn mtn-test-user`
- To generate a test user token, run the command `yarn mtn-test-user-tokens`
